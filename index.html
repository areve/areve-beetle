<html>
  <head>
    <title>test Ws mqtt.js</title>
  </head>
  <body>
    <h2>Data</h2>
    <textarea id="data" style="width:100%;height:300px">

    </textarea>
    <button type="button" onclick="load()">Load</button>
    <button type="button" onclick="save()">Save</button>

    <h2>Log</h2>
    <ul id="log"></ul>

    <script src="./mqtt"></script>
    <script>
      
      var client = mqtt.connect("wss://areve-beetle.herokuapp.com");
      client.subscribe("log");

      client.on("message", function(topic, message) {
        context = message.toString();
        console.log(topic, context);
        var entry = document.createElement("li");
        entry.innerText = [topic, context].join(": ");
        document.getElementById("log").appendChild(entry);
        window.scrollTo(0, document.body.scrollHeight);
      });

      load();
      function load() {
        var xhr = new XMLHttpRequest();
        xhr.addEventListener("load", function() {
          var data = JSON.parse(xhr.responseText)
          document.getElementById('data').value = JSON.stringify(data, null, '  ')
        });
        xhr.open('GET', '/data', true);
        xhr.send();
      }
      function save() {
        var data = JSON.parse(document.getElementById('data').value)

        var xhr = new XMLHttpRequest();
        xhr.addEventListener("load", function() {
          var data = JSON.parse(xhr.responseText)
          document.getElementById('data').value = JSON.stringify(data, null, '  ')
        });
        xhr.open('POST', '/data', true);
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xhr.send(JSON.stringify(data));      
      }
    </script>
  </body>
</html>
