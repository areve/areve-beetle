<html>
  <head>
    <title>test Ws mqtt.js</title>
    <style type="text/css">
    #log {
      width: 95%;
      height: 400px;
      overflow: auto;
      border: 1px solid burlywood;
    }
    </style>
  </head>
  <body>
    <h2>Data</h2>
    <textarea id="data" style="width:100%;height:300px">

    </textarea>
    <button type="button" onclick="load()">Load</button>
    <button type="button" onclick="save()">Save</button>

    <h2>Log</h2>
    <ul id="log"></ul>

    <script src="./mqtt"></script>
    <script>
      console.log(document.location.protocol)
      var client = mqtt.connect((document.location.protocol === 'http:' ? 'ws' : 'wss')  + "://" + document.location.hostname + "/mqtt");
      client.subscribe("log");

      client.on("message", function(topic, message) {
        context = message.toString();
        console.log(topic, context);
        var entry = document.createElement("li");
        entry.innerText = [topic, context].join(": ");
        var log = document.getElementById("log")
        var entries = log.getElementsByTagName('li');
        if (entries.length >= 1000) {
          document.getElementById("log").removeChild(entries[0])
        }
        log.appendChild(entry);
        log.scrollTo(0, log.scrollHeight);
      });

      load();
      function load() {
        var xhr = new XMLHttpRequest();
        xhr.addEventListener("load", function() {
          var data = JSON.parse(xhr.responseText)
          document.getElementById('data').value = JSON.stringify(data, null, '  ')
        });
        xhr.open('GET', '/data', true);
        xhr.send();
      }
      function save() {
        var data = JSON.parse(document.getElementById('data').value)

        var xhr = new XMLHttpRequest();
        xhr.addEventListener("load", function() {
          var data = JSON.parse(xhr.responseText)
          document.getElementById('data').value = JSON.stringify(data, null, '  ')
        });
        xhr.open('POST', '/data', true);
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xhr.send(JSON.stringify(data));      
      }
    </script>
  </body>
</html>
